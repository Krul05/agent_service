name: CI + AI Reviewer

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  ci:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ job.status }}
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install project deps (best-effort)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install .; fi

      - name: Run tests (capture output)
        shell: bash
        run: |
          set -o pipefail
          echo "=== CI START ===" > ci_output.txt
          if command -v pytest >/dev/null 2>&1; then
            pytest -q 2>&1 | tee -a ci_output.txt
          else
            echo "pytest not found, skipping" | tee -a ci_output.txt
          fi
          echo "=== CI END ===" >> ci_output.txt

      - name: Upload CI output artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-output
          path: ci_output.txt
          if-no-files-found: warn

  ai-reviewer:
    runs-on: ubuntu-latest
    needs: [ci]
    if: always()   # <-- важно: ревьюер запускается даже если ci упал
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download CI output artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-output
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run AI Reviewer Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.API_KEY }}
          MODEL: openai/gpt-4o-mini
          CI_RESULT: ${{ needs.ci.result }}
          CI_OUTPUT_PATH: ci_output.txt
        run: |
          python -m reviewer.main
